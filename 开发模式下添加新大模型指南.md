# 开发模式添加新模型指南

本文档旨在指导开发者如何在《智者计划》项目中添加新的 AI 模型或接入新的 AI 服务商。

本项目采用了 **注册表模式 (Registry Pattern)** 和 **工厂模式 (Factory Pattern)** 来管理 AI 服务，使得扩展非常灵活。

---

## 1. 核心架构与文件结构

在动手之前，请先了解 `electron/providers/` 目录下的核心文件及其职责：

| 文件         | 路径                                                | 职责                                                                                                   |
| :----------- | :-------------------------------------------------- | :----------------------------------------------------------------------------------------------------- |
| **注册表**   | `electron/providers/provider-registry.cjs`          | **核心配置中心**。定义所有支持的厂商、API 地址、模型列表、速率限制等静态数据。90% 的修改都在这里完成。 |
| **通用驱动** | `electron/providers/openai-compatible-provider.cjs` | **通用适配器**。处理所有兼容 OpenAI 接口格式的厂商（如 DeepSeek、智谱、Kimi、Groq 等）。               |
| **工厂**     | `electron/providers/provider-factory.cjs`           | **实例化工厂**。根据配置中的 `type` 字段，决定实例化哪个驱动类。                                       |
| **AI 服务**  | `electron/ai-service.cjs`                           | **业务逻辑层**。处理 API 调用、错误重试、速率限制管理以及特定厂商的错误码映射。                        |

---

## 2. 场景一：给现有厂商添加新模型（最常见）

**场景**：例如 SiliconFlow 上架了新的 `DeepSeek-V4`，或者你想为 OpenAI 添加 `gpt-6`。

### 步骤：

1.  打开 `electron/providers/provider-registry.cjs`。
2.  找到对应厂商的配置块（例如 `siliconflow`）。
3.  在 `models` 数组中追加新的模型对象。

### 配置示例：

```javascript
// 在 models 数组中添加：
{
  // 【必填】API调用时的真实模型ID，必须与官方文档完全一致
  id: 'deepseek-ai/DeepSeek-V4',

  // 【必填】UI显示的名称，建议简洁易读
  name: 'DeepSeek-V4',

  // 【必填】UI显示的描述，简要说明模型特点
  description: '最新推理模型',

  // 【可选】速率限制配置 (覆盖厂商默认值)
  rateLimits: {
    rpm: 1000,   // Requests Per Minute (每分钟请求数)
    tpm: 100000  // Tokens Per Minute (每分钟 Token 数)
  }
},
```

4.  **重启应用**以生效。

---

## 3. 场景二：添加新的 OpenAI 兼容厂商（常见）

**场景**：接入 "Moonshot AI (Kimi)"、"阶跃星辰" 或 "零一万物" 等支持 OpenAI 格式的厂商。

### 步骤：

1.  打开 `electron/providers/provider-registry.cjs`。
2.  在 `PROVIDER_REGISTRY` 对象中找一个空位（建议按区域分类）。
3.  添加一个新的厂商配置对象。

### 完整配置模板：

```javascript
  // 示例：添加 Moonshot AI
  moonshot: {
    // 【必填】内部唯一ID，用于代码引用
    id: 'moonshot',

    // 【必填】UI 显示名称
    name: 'Moonshot AI (Kimi)',

    // 【关键】指定使用通用驱动
    type: 'openai-compatible',

    // 【必填】API Base URL (通常以 /v1 结尾)
    baseUrl: 'https://api.moonshot.cn/v1',

    // 【必填】默认选中的模型 ID
    defaultModel: 'moonshot-v1-8k',

    // 【必填】模型列表
    models: [
      { id: 'moonshot-v1-8k', name: 'Kimi 8k', description: '通用版本', rateLimits: { rpm: 3, tpm: 30000 } },
      { id: 'moonshot-v1-32k', name: 'Kimi 32k', description: '长文本', rateLimits: { rpm: 3, tpm: 30000 } },
    ],

    // 【必填】区域分组 ('china' 或 'international')
    region: 'china',

    // 【必填】是否建议开启代理 (仅作 UI 提示)
    requiresProxy: false,

    // 【可选】UI 底部显示的备注信息
    note: '前往 Moonshot 开放平台获取 API Key',
  },
```

4.  **无需修改其他文件**，前端会自动读取并渲染该厂商。
5.  **重启应用**以生效。

---

## 4. 场景三：添加非标准 API 厂商（进阶）

**场景**：接入一个完全自研的本地模型，或者像旧版 Claude/Gemini 那样不支持 OpenAI 格式的 API。

### 步骤：

1.  **创建驱动文件**：
    在 `electron/providers/` 下新建文件，例如 `my-custom-provider.cjs`，继承 `BaseProvider`。

    ```javascript
    const { BaseProvider } = require("./base-provider.cjs");

    class MyCustomProvider extends BaseProvider {
      // 必须实现 complete 方法
      async complete(prompt, systemInstruction, options) {
        // 1. 构建特殊的请求体
        const body = {
          input: prompt,
          config: { system: systemInstruction },
        };

        // 2. 发起请求
        const response = await fetch(this.baseUrl, {
          method: "POST",
          headers: { Authorization: this.apiKey },
          body: JSON.stringify(body),
        });

        // 3. 解析并返回纯文本
        const data = await response.json();
        return data.result.text;
      }
    }

    module.exports = { MyCustomProvider };
    ```

2.  **注册配置**：
    在 `provider-registry.cjs` 中添加配置，将 `type` 设置为你的自定义类型，例如 `type: 'my-custom'`.

3.  **注册工厂**：
    打开 `electron/providers/provider-factory.cjs`：

    - 引入你的类：`const { MyCustomProvider } = require('./my-custom-provider.cjs');`
    - 在 `createProvider` 函数的 `switch` 语句中添加分支：

    ```javascript
    switch (providerConfig.type) {
      case "my-custom":
        return new MyCustomProvider(mergedConfig);
      // ...
    }
    ```

---

## 5. 进阶：自定义错误处理

为了提供更好的用户体验，建议在 `electron/ai-service.cjs` 中添加针对该厂商的错误码映射。

### 步骤：

1.  打开 `electron/ai-service.cjs`。
2.  找到 `testConnection` 方法中的错误处理逻辑（约第 260 行）。
3.  在 `has` 辅助函数和错误判断逻辑中，添加该厂商特有的错误关键词。

```javascript
// 示例：添加智谱 AI 的特定错误码 1001
else if (has('1001', 'signature')) {
  errorMessage = '智谱AI：JWT 签名校验失败，请检查 API Key 是否正确';
}
```

---

## 6. 验证与调试

### 验证清单：

1.  **重启应用**：Electron 主进程代码修改后必须重启（终端运行 `npm run dev` 或 `rs`）。
2.  **检查设置界面**：
    - 进入 "设置" -> "AI 核心选择"。
    - 确认新厂商出现在对应的区域分组（国内/国际）中。
    - 确认右侧 "模型配置" 下拉框包含你添加的所有模型。
3.  **连接测试**：
    - 输入 API Key。
    - 点击 "保存密钥"。
    - 点击 "测试连接"，观察是否显示 "✓ 连接成功" 及响应时间。
4.  **生成测试**：
    - 在 "数据合成" 区域输入一段简单的文本。
    - 点击 "启动合成"，确认能正常生成题目。

### 常见问题：

- **Unknown provider type**：检查 `provider-registry.cjs` 里的 `type` 拼写是否正确，以及是否在 `provider-factory.cjs` 里注册了（如果是自定义类型）。
- **404 Not Found**：检查 `baseUrl`。OpenAI 兼容接口通常需要以 `/v1` 结尾，但也有些厂商（如百度千帆新版）是 `/v2`。
- **401 Unauthorized**：API Key 错误，或者该厂商需要特殊的 Header（可在 `OpenAICompatibleProvider` 中通过 `extraHeaders` 处理）。

---

**祝你开发愉快！**
