# 开发模式添加新模型指南

本文档旨在指导新加入的开发者如何在《智者计划》项目中添加新的 AI 模型或 AI 服务商。

本项目采用了 **注册表模式 (Registry Pattern)** 和 **工厂模式 (Factory Pattern)** 来管理 AI 服务，扩展非常容易。

---

## 1. 准备工作

在开始之前，请确保你已经准备好了以下环境：

*   **代码编辑器**：推荐使用 VS Code。
*   **Node.js 环境**：确保已安装 Node.js (v18+)。
*   **项目代码**：确保你已经拉取了最新的项目代码。
*   **API 密钥**：如果你要添加新的厂商，你需要先去该厂商的官网注册并获取 API Key。

---

## 2. 核心文件结构

在动手之前，请先了解 `electron/providers/` 目录下的三个关键文件：

1.  **`provider-registry.cjs` (核心配置)**
    *   **作用**：这是你 99% 的时间只需要修改的文件。它定义了所有支持的厂商、API 地址、模型列表、速率限制等静态数据。
    *   **位置**：`electron/providers/provider-registry.cjs`

2.  **`openai-compatible-provider.cjs` (通用驱动)**
    *   **作用**：这是一个通用的 API 处理器。目前市面上绝大多数 AI（DeepSeek、Kimi、智谱、阿里通义等）都兼容 OpenAI 接口格式。只要厂商支持 OpenAI 格式，你就**不需要写一行代码**，只改配置即可。
    *   **位置**：`electron/providers/openai-compatible-provider.cjs`

3.  **`provider-factory.cjs` (组装工厂)**
    *   **作用**：负责读取配置并生成实例。只有当你添加一个**完全不支持** OpenAI 格式的怪异厂商时，才需要修改这里。
    *   **位置**：`electron/providers/provider-factory.cjs`

---

## 3. 场景一：给现有厂商添加新模型（最常见）

**场景**：比如 SiliconFlow (硅基流动) 上架了新的 `DeepSeek-V4`，或者你想添加 `Qwen-Max`。

### 详细步骤：

1.  **打开文件**：
    在 VS Code 中打开 `electron/providers/provider-registry.cjs`。

2.  **定位厂商**：
    使用搜索功能（Ctrl+F）搜索对应的厂商 ID（例如 `siliconflow` 或 `zhipu`）。

3.  **找到 `models` 数组**：
    在厂商配置对象中找到 `models: [...]` 字段。

4.  **添加模型配置**：
    在数组末尾追加一个新的对象。请参考以下详细参数说明：

### 代码示例与参数详解：

```javascript
// 在 siliconflow.models 数组中添加：
{ 
  // 【必填】API调用时的真实模型ID，必须与官方文档完全一致，区分大小写
  id: 'deepseek-ai/DeepSeek-V4',  
  
  // 【必填】UI显示的名称，可以自定义，建议简洁易读
  name: 'DeepSeek-V4',            
  
  // 【必填】UI显示的描述，简要说明模型特点
  description: '最新发布的推理模型', 
  
  // 【可选】速率限制配置，如果不填则使用厂商默认值
  // 建议根据你的 API 等级填写，防止被厂商封禁
  rateLimits: {
    rpm: 500,    // Requests Per Minute (每分钟请求数限制)
    tpm: 50000,  // Tokens Per Minute (每分钟 Token 数限制)
    rpd: 0       // Requests Per Day (每天请求数限制，0表示不限制)
  }
},
```

5.  **保存文件**：按 Ctrl+S 保存。
6.  **重启程序**：见第 6 节。

---

## 4. 场景二：添加新的 OpenAI 兼容厂商（常见）

**场景**：你想添加 "Moonshot AI (Kimi)" 或 "零一万物"，它们都支持 OpenAI 格式的 API。

### 详细步骤：

1.  **打开文件**：
    打开 `electron/providers/provider-registry.cjs`。

2.  **选择位置**：
    在 `PROVIDER_REGISTRY` 对象中，找个空位（建议按注释分类放，例如在 "中国云提供商" 下面）。

3.  **添加厂商配置**：
    复制以下模板并修改。

### 代码示例与参数详解：

```javascript
  // 添加 Moonshot AI (Kimi)
  moonshot: {
    // 【必填】内部唯一ID，不能与现有 ID 重复
    id: 'moonshot',             
    
    // 【必填】厂商显示名称，显示在设置界面的左侧列表中
    name: 'Moonshot AI (Kimi)', 
    
    // 【必填】必须填 'openai-compatible'，表示使用通用驱动
    type: 'openai-compatible',  
    
    // 【必填】官方文档提供的 Base URL，通常以 /v1 结尾
    baseUrl: 'https://api.moonshot.cn/v1', 
    
    // 【必填】默认选中的模型 ID，必须存在于下面的 models 数组中
    defaultModel: 'moonshot-v1-8k',        
    
    // 【必填】模型列表
    models: [
      { id: 'moonshot-v1-8k', name: 'Kimi 8k', description: '通用版本' },
      { id: 'moonshot-v1-32k', name: 'Kimi 32k', description: '长文本版本' },
      { id: 'moonshot-v1-128k', name: 'Kimi 128k', description: '超长上下文' },
    ],
    
    // 【必填】'china' 或 'international'，用于前端分组显示
    region: 'china',            
    
    // 【必填】是否通常需要代理（仅作UI提示用，不影响实际逻辑）
    requiresProxy: false,       
  },
```

4.  **保存并重启程序**。

---

## 5. 场景三：添加特殊协议厂商（高阶/罕见）

**场景**：你要接入一个完全自研的本地模型，或者像早期的 Claude 那样不支持 OpenAI 格式的 API。

### 详细步骤：

1.  **创建驱动文件**：
    在 `electron/providers/` 下新建文件，例如 `my-custom-provider.cjs`。
    
    ```javascript
    const { BaseProvider } = require('./base-provider.cjs');

    class MyCustomProvider extends BaseProvider {
      // 必须实现 complete 方法
      async complete(prompt, systemInstruction, options) {
        // 1. 构建你自己特殊的请求格式
        const body = {
            input: prompt,
            config: systemInstruction
            // ...
        };
        
        // 2. 发起请求
        const response = await fetch(this.baseUrl, { ... });
        
        // 3. 解析并返回纯文本结果
        return response.data.text;
      }
      
      // 必须实现 getAvailableModels
      getAvailableModels() {
        return this.providerConfig.models;
      }
    }
    
    module.exports = { MyCustomProvider };
    ```

2.  **注册配置**：
    在 `provider-registry.cjs` 中添加配置，注意 `type` 字段要唯一，例如 `type: 'my-custom'`.

3.  **注册工厂**：
    打开 `electron/providers/provider-factory.cjs`：
    *   引入你的类：`const { MyCustomProvider } = require('./my-custom-provider.cjs');`
    *   在 `switch (providerConfig.type)` 中添加分支：
    
    ```javascript
    case 'my-custom':
      return new MyCustomProvider(mergedConfig);
    ```

---

## 6. 验证与调试指南

### 如何确认添加成功？
1.  **重启应用**：
    *   Electron 的主进程代码修改后**必须重启**才能生效。
    *   如果你是在终端运行的，按 `Ctrl+C` 停止，然后重新运行 `npm run dev`。
    *   如果你使用了 `electron-vite` 等工具，可以在终端输入 `rs` 尝试热重启。
2.  **检查 UI**：
    *   进入 "设置" -> "AI 模型设置"。
    *   **新厂商**：应该出现在左侧厂商列表中。
    *   **新模型**：应该出现在右侧 "选择模型" 下拉框中。
3.  **功能测试**：
    *   选择你新添加的模型。
    *   填入正确的 API Key。
    *   点击 "保存配置"。
    *   去 "开始游戏" -> "自定义生成"，尝试生成一个简单的题目，看是否成功。

### 常见问题排查

| 现象 | 可能原因 | 解决方案 |
| :--- | :--- | :--- |
| **报错 `Unknown provider type`** | `type` 字段拼写错误 | 检查 `provider-registry.cjs`，确保 `type` 是 `'openai-compatible'`。 |
| **模型列表没更新** | 未重启应用或语法错误 | 重启应用；检查 `provider-registry.cjs` 是否有语法错误（如少逗号）。 |
| **调用报错 404** | Base URL 错误 | 检查 `baseUrl` 是否正确。有些厂商需要 `/v1` 结尾，有些不需要。 |
| **调用报错 400 Bad Request** | 模型 ID 错误 | 检查 `models` 里的 `id` 是否与官方文档一致。 |
| **调用报错 401 Unauthorized** | API Key 错误 | 检查你在设置界面输入的 API Key 是否正确。 |
| **调用报错 429 Too Many Requests** | 速率限制过低 | 检查 `rateLimits` 配置，或者你的账号余额不足/等级不够。 |

---

**祝你开发愉快！**
